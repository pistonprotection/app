{{- if not .Values.secrets.externalSecrets.enabled }}
# Standard Kubernetes Secret (when not using external-secrets)
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "pistonprotection.fullname" . }}-secrets
  labels:
    {{- include "pistonprotection.labels" . | nindent 4 }}
type: Opaque
stringData:
  # Database connection URL
  {{- if .Values.postgresql.enabled }}
  database-url: "postgresql://{{ .Values.postgresql.auth.username }}:{{ .Values.postgresql.auth.password }}@{{ include "pistonprotection.fullname" . }}-postgresql:5432/{{ .Values.postgresql.auth.database }}?sslmode=prefer"
  {{- else if .Values.postgresql.external.existingSecret }}
  {{- /* External secret reference - will be mounted separately */ -}}
  {{- else }}
  database-url: "postgresql://{{ .Values.postgresql.external.username }}:{{ .Values.postgresql.external.password }}@{{ .Values.postgresql.external.host }}:{{ .Values.postgresql.external.port }}/{{ .Values.postgresql.external.database }}?sslmode={{ .Values.postgresql.external.sslMode }}"
  {{- end }}

  # Redis connection URL
  {{- if .Values.redis.enabled }}
  redis-url: "redis://:{{ .Values.redis.auth.password }}@{{ include "pistonprotection.fullname" . }}-redis-master:6379/{{ .Values.redis.external.database | default 0 }}"
  {{- else if .Values.redis.external.existingSecret }}
  {{- /* External secret reference - will be mounted separately */ -}}
  {{- else }}
  redis-url: "redis{{ if .Values.redis.external.tls }}s{{ end }}://:{{ .Values.redis.external.password }}@{{ .Values.redis.external.host }}:{{ .Values.redis.external.port }}/{{ .Values.redis.external.database }}"
  {{- end }}

  # JWT signing key (generate if not provided)
  {{- if .Values.secrets.jwtSigningKey }}
  jwt-signing-key: {{ .Values.secrets.jwtSigningKey | quote }}
  {{- else }}
  jwt-signing-key: {{ randAlphaNum 64 | quote }}
  {{- end }}

  # Encryption key for sensitive data (generate if not provided)
  {{- if .Values.secrets.encryptionKey }}
  encryption-key: {{ .Values.secrets.encryptionKey | quote }}
  {{- else }}
  encryption-key: {{ randAlphaNum 32 | b64enc | quote }}
  {{- end }}

  {{- if .Values.stripe.enabled }}
  {{- if not .Values.stripe.existingSecret }}
  # Stripe credentials
  stripe-api-key: {{ .Values.stripe.apiKey | quote }}
  stripe-webhook-secret: {{ .Values.stripe.webhookSecret | quote }}
  {{- end }}
  {{- end }}

  {{- if .Values.geoip.enabled }}
  {{- if not .Values.geoip.existingSecret }}
  # GeoIP credentials
  geoip-account-id: {{ .Values.geoip.accountId | quote }}
  geoip-license-key: {{ .Values.geoip.licenseKey | quote }}
  {{- end }}
  {{- end }}

{{- else }}
# ExternalSecret for external-secrets operator integration
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "pistonprotection.fullname" . }}-secrets
  labels:
    {{- include "pistonprotection.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.secrets.externalSecrets.refreshInterval }}
  secretStoreRef:
    name: {{ .Values.secrets.externalSecrets.secretStoreRef.name }}
    kind: {{ .Values.secrets.externalSecrets.secretStoreRef.kind }}
  target:
    name: {{ include "pistonprotection.fullname" . }}-secrets
    creationPolicy: Owner
  data:
    # Database credentials
    - secretKey: database-url
      remoteRef:
        key: pistonprotection/database
        property: url

    # Redis credentials
    - secretKey: redis-url
      remoteRef:
        key: pistonprotection/redis
        property: url

    # JWT signing key
    - secretKey: jwt-signing-key
      remoteRef:
        key: pistonprotection/auth
        property: jwt-signing-key

    # Encryption key
    - secretKey: encryption-key
      remoteRef:
        key: pistonprotection/auth
        property: encryption-key

    {{- if .Values.stripe.enabled }}
    # Stripe credentials
    - secretKey: stripe-api-key
      remoteRef:
        key: pistonprotection/stripe
        property: api-key
    - secretKey: stripe-webhook-secret
      remoteRef:
        key: pistonprotection/stripe
        property: webhook-secret
    {{- end }}

    {{- if .Values.geoip.enabled }}
    # GeoIP credentials
    - secretKey: geoip-account-id
      remoteRef:
        key: pistonprotection/geoip
        property: account-id
    - secretKey: geoip-license-key
      remoteRef:
        key: pistonprotection/geoip
        property: license-key
    {{- end }}
{{- end }}

---
{{- if and .Values.postgresql.enabled .Values.postgresql.auth.existingSecret }}
# PostgreSQL password reference (when using existing secret)
# The bitnami/postgresql subchart manages its own secret automatically
{{- end }}

---
{{- if and .Values.redis.enabled .Values.redis.auth.existingSecret }}
# Redis password reference (when using existing secret)
# The bitnami/redis subchart manages its own secret automatically
{{- end }}

---
{{- if and .Values.stripe.enabled .Values.stripe.existingSecret }}
# Stripe credentials reference (when using existing secret)
# The secret {{ .Values.stripe.existingSecret }} must contain:
# - {{ .Values.stripe.apiKeyKey }}: Stripe API key
# - {{ .Values.stripe.webhookSecretKey }}: Stripe webhook signing secret
{{- end }}

---
{{- if and .Values.geoip.enabled .Values.geoip.existingSecret }}
# GeoIP credentials reference (when using existing secret)
# The secret {{ .Values.geoip.existingSecret }} must contain:
# - account-id: MaxMind account ID
# - license-key: MaxMind license key
{{- end }}

---
{{- if .Values.observability.loki.enabled }}
{{- if .Values.observability.loki.tenantId }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "pistonprotection.fullname" . }}-loki
  labels:
    {{- include "pistonprotection.labels" . | nindent 4 }}
type: Opaque
stringData:
  tenant-id: {{ .Values.observability.loki.tenantId | quote }}
{{- end }}
{{- end }}

---
{{- if .Values.auth.config.oauth.enabled }}
{{- range .Values.auth.config.oauth.providers }}
# OAuth provider secrets are expected to exist as {{ .clientSecretRef }}
# Each secret must contain a 'client-secret' key
{{- end }}
{{- end }}
