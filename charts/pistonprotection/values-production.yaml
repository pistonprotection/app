# PistonProtection Helm Chart - Production Values
# Use this file for production deployments with high availability and security

# Global settings
global:
  imagePullSecrets:
    - name: pistonprotection-registry
  storageClass: "fast-ssd"
  environment: production
  logLevel: info

# =============================================================================
# Gateway Service - Production Configuration
# =============================================================================
gateway:
  enabled: true
  replicaCount: 3
  image:
    repository: ghcr.io/pistonprotection/gateway
    pullPolicy: IfNotPresent
  service:
    type: ClusterIP
    port: 8080
    grpcPort: 9090
    metricsPort: 9091
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 2Gi
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 20
    targetCPUUtilization: 70
    targetMemoryUtilization: 75
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
          - type: Percent
            value: 10
            periodSeconds: 60
      scaleUp:
        stabilizationWindowSeconds: 0
        policies:
          - type: Percent
            value: 100
            periodSeconds: 15
          - type: Pods
            value: 4
            periodSeconds: 15
        selectPolicy: Max
  pdb:
    enabled: true
    minAvailable: 2
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/component: gateway
            topologyKey: topology.kubernetes.io/zone
  config:
    connectionPoolSize: 200
    requestTimeout: 30
    maxConcurrentConnections: 50000
    requestLogging: true
    cors:
      enabled: true
      allowOrigins:
        - "https://dashboard.pistonprotection.io"
        - "https://app.pistonprotection.io"
      allowMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowHeaders:
        - Authorization
        - Content-Type
        - X-Request-ID
      maxAge: 86400

# =============================================================================
# Worker Service - Production Configuration
# =============================================================================
worker:
  enabled: true
  kind: DaemonSet
  image:
    repository: ghcr.io/pistonprotection/worker
    pullPolicy: IfNotPresent
  hostNetwork: true
  dnsPolicy: ClusterFirstWithHostNet
  resources:
    requests:
      cpu: 500m
      memory: 256Mi
    limits:
      cpu: 4000m
      memory: 2Gi
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  nodeSelector:
    pistonprotection.io/worker: "true"
  tolerations:
    - key: "pistonprotection.io/worker"
      operator: "Exists"
      effect: "NoSchedule"
    - key: "node-role.kubernetes.io/master"
      operator: "Exists"
      effect: "NoSchedule"
  config:
    networkInterface: eth0
    xdpMode: native
    perCpuMaps: true
    mapSize: 262144
    statsInterval: 5

# =============================================================================
# Config Manager Service - Production Configuration
# =============================================================================
configMgr:
  enabled: true
  replicaCount: 2
  image:
    repository: ghcr.io/pistonprotection/config-mgr
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilization: 70
  pdb:
    enabled: true
    minAvailable: 1
  config:
    syncInterval: 15
    enableValidation: true
    cacheTtl: 300

# =============================================================================
# Metrics Service - Production Configuration
# =============================================================================
metrics:
  enabled: true
  replicaCount: 2
  image:
    repository: ghcr.io/pistonprotection/metrics
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 2Gi
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilization: 70
  pdb:
    enabled: true
    minAvailable: 1
  config:
    aggregationInterval: 10
    retentionPeriod: 72h
    perIpMetrics: true
    maxTrackedIps: 500000

# =============================================================================
# Auth Service - Production Configuration
# =============================================================================
auth:
  enabled: true
  replicaCount: 3
  image:
    repository: ghcr.io/pistonprotection/auth
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 15
    targetCPUUtilization: 70
  pdb:
    enabled: true
    minAvailable: 2
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/component: auth
            topologyKey: topology.kubernetes.io/zone
  config:
    jwtExpiration: 1h
    refreshTokenExpiration: 7d
    passwordMinLength: 14
    mfaEnabled: true
    sessionTimeout: 30
    maxLoginAttempts: 5
    lockoutDuration: 30
    apiKeys:
      enabled: true
      prefix: "pp_"
      defaultExpiration: 365

# =============================================================================
# Operator - Production Configuration
# =============================================================================
operator:
  enabled: true
  replicaCount: 1
  image:
    repository: ghcr.io/pistonprotection/operator
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  installCRDs: true
  config:
    leaderElection: true
    reconcileInterval: 30
    watchAllNamespaces: false

# =============================================================================
# Frontend - Production Configuration
# =============================================================================
frontend:
  enabled: true
  replicaCount: 3
  image:
    repository: ghcr.io/pistonprotection/frontend
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilization: 70
  pdb:
    enabled: true
    minAvailable: 2
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/component: frontend
            topologyKey: topology.kubernetes.io/zone
  config:
    enableRealtime: true
    refreshInterval: 5
    defaultTheme: system

# =============================================================================
# Ingress - Production Configuration
# =============================================================================
ingress:
  enabled: true
  className: nginx
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"
  hosts:
    - host: dashboard.pistonprotection.io
      paths:
        - path: /
          pathType: Prefix
          service: frontend
        - path: /api
          pathType: Prefix
          service: gateway
        - path: /auth
          pathType: Prefix
          service: auth
  tls:
    - secretName: pistonprotection-tls
      hosts:
        - dashboard.pistonprotection.io

# =============================================================================
# PostgreSQL - Production Configuration
# =============================================================================
postgresql:
  enabled: true
  auth:
    postgresPassword: ""  # Set via external secret
    username: pistonprotection
    password: ""  # Set via external secret
    database: pistonprotection
    existingSecret: pistonprotection-postgresql-credentials
  primary:
    persistence:
      enabled: true
      size: 100Gi
      storageClass: fast-ssd
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 4Gi
    configuration: |
      max_connections = 500
      shared_buffers = 1GB
      effective_cache_size = 3GB
      maintenance_work_mem = 256MB
      checkpoint_completion_target = 0.9
      wal_buffers = 16MB
      default_statistics_target = 100
      random_page_cost = 1.1
      effective_io_concurrency = 200
      min_wal_size = 2GB
      max_wal_size = 8GB
      max_worker_processes = 8
      max_parallel_workers_per_gather = 4
      max_parallel_workers = 8

# =============================================================================
# Redis - Production Configuration
# =============================================================================
redis:
  enabled: true
  architecture: replication
  auth:
    enabled: true
    password: ""  # Set via external secret
    existingSecret: pistonprotection-redis-credentials
  master:
    persistence:
      enabled: true
      size: 10Gi
      storageClass: fast-ssd
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 1Gi
    configuration: |
      maxmemory 512mb
      maxmemory-policy allkeys-lru
      appendonly yes
      appendfsync everysec
  replica:
    replicaCount: 2
    persistence:
      enabled: true
      size: 10Gi
      storageClass: fast-ssd
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

# =============================================================================
# Observability - Production Configuration
# =============================================================================
observability:
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: monitoring
      interval: 15s
      scrapeTimeout: 10s
      labels:
        release: prometheus
    rules:
      enabled: true
      namespace: monitoring
      labels:
        release: prometheus

  grafana:
    enabled: true
    dashboards:
      enabled: true
      labels:
        grafana_dashboard: "1"
      folder: "PistonProtection"

  loki:
    enabled: true
    url: "http://loki.monitoring.svc.cluster.local:3100"
    tenantId: "pistonprotection"
    labels:
      app: pistonprotection
      environment: production

  tracing:
    enabled: true
    endpoint: "http://tempo.monitoring.svc.cluster.local:4317"
    samplingRatio: 0.01
    serviceName: pistonprotection

# =============================================================================
# GeoIP - Production Configuration
# =============================================================================
geoip:
  enabled: true
  type: maxmind
  existingSecret: pistonprotection-geoip-credentials
  editionIds:
    - GeoLite2-Country
    - GeoLite2-City
    - GeoLite2-ASN
  updateSchedule: "0 3 * * *"  # Daily at 3am
  storage:
    enabled: true
    size: 2Gi
    storageClass: fast-ssd

# =============================================================================
# Stripe - Production Configuration
# =============================================================================
stripe:
  enabled: true
  existingSecret: pistonprotection-stripe-credentials
  webhookPath: /webhooks/stripe
  testMode: false
  prices:
    starter: "price_starter_monthly"
    professional: "price_professional_monthly"
    enterprise: "price_enterprise_monthly"

# =============================================================================
# Security - Production Configuration
# =============================================================================
networkPolicy:
  enabled: true
  allowedNamespaces:
    - monitoring
    - ingress-nginx
  allowedCIDRs: []

secrets:
  externalSecrets:
    enabled: true
    refreshInterval: 1h
    secretStoreRef:
      name: vault-backend
      kind: ClusterSecretStore

# =============================================================================
# Protection Settings - Production Configuration
# =============================================================================
protection:
  defaultLevel: 3
  rateLimit:
    ppsPerIp: 2000
    burst: 5000
    globalPps: 5000000
    connectionsPerIp: 200
    newConnectionsPerSecond: 100
  protocols:
    minecraft:
      enabled: true
      minVersion: 47
      maxVersion: 769
      packetInspection: true
      maxPacketSize: 32767
    quic:
      enabled: true
      maxStreams: 200
    synCookies:
      enabled: true
      threshold: 2000
    tcp:
      enabled: true
      maxSegmentSize: 1460
      connectionTracking: true
    udp:
      enabled: true
      timeout: 30
  challenge:
    jsChallenge: true
    cookieLifetime: 3600
    difficulty: 7
  lists:
    blacklistEnabled: true
    whitelistEnabled: true
    autoBlacklistThreshold: 10
    autoBlacklistDuration: 7200

# =============================================================================
# Pod Priority and Topology
# =============================================================================
priorityClassName: high-priority

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: pistonprotection
