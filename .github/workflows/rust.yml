# =============================================================================
# PistonProtection - Rust Services CI Workflow
# =============================================================================
# This workflow handles CI for Rust services and the Kubernetes operator.
# Includes format check, clippy linting, tests, and build verification.
# =============================================================================

name: Rust CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'services/**'
      - 'operator/**'
      - 'proto/**'
      - '.github/workflows/rust.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'services/**'
      - 'operator/**'
      - 'proto/**'
      - '.github/workflows/rust.yml'
  workflow_dispatch:

concurrency:
  group: rust-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: -D warnings
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

jobs:
  # ===========================================================================
  # Format Check - Services
  # ===========================================================================
  format-services:
    name: Format Check (Services)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check
        working-directory: services

  # ===========================================================================
  # Format Check - Operator
  # ===========================================================================
  format-operator:
    name: Format Check (Operator)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check
        working-directory: operator

  # ===========================================================================
  # Clippy Lint - Services
  # ===========================================================================
  lint-services:
    name: Clippy Lint (Services)
    runs-on: ubuntu-latest
    needs: format-services
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install protobuf compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libprotobuf-dev

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('services/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: services/target
          key: ${{ runner.os }}-cargo-services-lint-${{ hashFiles('services/Cargo.lock') }}-${{ hashFiles('services/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-cargo-services-lint-${{ hashFiles('services/Cargo.lock') }}-
            ${{ runner.os }}-cargo-services-lint-

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        working-directory: services

  # ===========================================================================
  # Clippy Lint - Operator
  # ===========================================================================
  lint-operator:
    name: Clippy Lint (Operator)
    runs-on: ubuntu-latest
    needs: format-operator
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-operator-${{ hashFiles('operator/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-operator-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: operator/target
          key: ${{ runner.os }}-cargo-operator-lint-${{ hashFiles('operator/Cargo.lock') }}-${{ hashFiles('operator/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-cargo-operator-lint-${{ hashFiles('operator/Cargo.lock') }}-
            ${{ runner.os }}-cargo-operator-lint-

      - name: Run clippy
        run: cargo clippy --all-targets -- -D warnings
        working-directory: operator

  # ===========================================================================
  # Tests - Services
  # ===========================================================================
  test-services:
    name: Tests (Services)
    runs-on: ubuntu-latest
    needs: lint-services
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: pistonprotection_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgres://test:test@localhost:5432/pistonprotection_test
      REDIS_URL: redis://localhost:6379
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install protobuf compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libprotobuf-dev

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('services/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: services/target
          key: ${{ runner.os }}-cargo-services-test-${{ hashFiles('services/Cargo.lock') }}-${{ hashFiles('services/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-cargo-services-test-${{ hashFiles('services/Cargo.lock') }}-
            ${{ runner.os }}-cargo-services-test-

      - name: Run unit tests
        run: cargo test --lib --all-features
        working-directory: services

      - name: Run integration tests
        run: |
          if find tests -name '*.rs' 2>/dev/null | head -1 | grep -q .; then
            cargo test --test '*' --all-features
          else
            echo "No integration tests found, skipping"
          fi
        working-directory: services
        continue-on-error: true

      - name: Run doc tests
        run: cargo test --doc --all-features
        working-directory: services

  # ===========================================================================
  # Tests - Operator
  # ===========================================================================
  test-operator:
    name: Tests (Operator)
    runs-on: ubuntu-latest
    needs: lint-operator
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-operator-${{ hashFiles('operator/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-operator-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: operator/target
          key: ${{ runner.os }}-cargo-operator-test-${{ hashFiles('operator/Cargo.lock') }}-${{ hashFiles('operator/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-cargo-operator-test-${{ hashFiles('operator/Cargo.lock') }}-
            ${{ runner.os }}-cargo-operator-test-

      - name: Run tests
        run: cargo test --all-features
        working-directory: operator

  # ===========================================================================
  # Build - Services (Release)
  # ===========================================================================
  build-services:
    name: Build (Services)
    runs-on: ubuntu-latest
    needs: test-services
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install protobuf compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libprotobuf-dev

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('services/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: services/target
          key: ${{ runner.os }}-cargo-services-build-${{ hashFiles('services/Cargo.lock') }}-${{ hashFiles('services/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-cargo-services-build-

      - name: Build services (release)
        run: cargo build --release --all-features
        working-directory: services

      - name: Verify binaries
        run: |
          echo "Built binaries:"
          find target/release -maxdepth 1 -type f -executable -name "pistonprotection-*" 2>/dev/null || \
          find target/release -maxdepth 1 -type f ! -name "*.d" ! -name "*.rlib" -name "*" 2>/dev/null | head -20
        working-directory: services

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rust-binaries-services
          path: |
            services/target/release/pistonprotection-*
          retention-days: 7

  # ===========================================================================
  # Build - Operator (Release)
  # ===========================================================================
  build-operator:
    name: Build (Operator)
    runs-on: ubuntu-latest
    needs: test-operator
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-operator-${{ hashFiles('operator/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-operator-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: operator/target
          key: ${{ runner.os }}-cargo-operator-build-${{ hashFiles('operator/Cargo.lock') }}-${{ hashFiles('operator/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-cargo-operator-build-

      - name: Build operator (release)
        run: cargo build --release
        working-directory: operator

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rust-binaries-operator
          path: |
            operator/target/release/pistonprotection-operator
          retention-days: 7

  # ===========================================================================
  # Cargo Check - All Targets
  # ===========================================================================
  check-all:
    name: Cargo Check (All)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install protobuf compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libprotobuf-dev

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-check-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-check-

      - name: Cargo check (services)
        run: cargo check --all-targets --all-features
        working-directory: services

      - name: Cargo check (operator)
        run: cargo check --all-targets
        working-directory: operator

  # ===========================================================================
  # CI Success Check
  # ===========================================================================
  ci-success:
    name: Rust CI Success
    runs-on: ubuntu-latest
    needs: [format-services, format-operator, lint-services, lint-operator, test-services, test-operator, build-services, build-operator, check-all]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Rust CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Services" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format Check | ${{ needs.format-services.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Clippy Lint | ${{ needs.lint-services.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test-services.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build-services.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Operator" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format Check | ${{ needs.format-operator.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Clippy Lint | ${{ needs.lint-operator.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test-operator.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build-operator.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cargo Check | ${{ needs.check-all.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check all jobs
        run: |
          failed=false

          # Services jobs
          if [[ "${{ needs.format-services.result }}" == "failure" ]] || \
             [[ "${{ needs.lint-services.result }}" == "failure" ]] || \
             [[ "${{ needs.test-services.result }}" == "failure" ]] || \
             [[ "${{ needs.build-services.result }}" == "failure" ]]; then
            echo "Services jobs failed"
            failed=true
          fi

          # Operator jobs
          if [[ "${{ needs.format-operator.result }}" == "failure" ]] || \
             [[ "${{ needs.lint-operator.result }}" == "failure" ]] || \
             [[ "${{ needs.test-operator.result }}" == "failure" ]] || \
             [[ "${{ needs.build-operator.result }}" == "failure" ]]; then
            echo "Operator jobs failed"
            failed=true
          fi

          # Check all job
          if [[ "${{ needs.check-all.result }}" == "failure" ]]; then
            echo "Cargo check failed"
            failed=true
          fi

          if $failed; then
            exit 1
          fi
          echo "All Rust CI jobs passed!"
